name: Build & Push CrewAI-Studio to GHCR

# ─────────────────────────────────────────────────────────────────────────────
# Required GitHub secrets:
#   GITHUB_TOKEN        – auto-provided, used to push images to GHCR
#   INFRA_DEPLOY_PAT    – PAT with `contents:write` on salih18/homelab-cluster
#                         (create at GitHub → Settings → Developer settings → PATs)
#
# Required self-hosted runner (for the deploy job):
#   A GitHub Actions self-hosted runner on a machine with LAN access
#   to the Talos cluster (e.g. 192.168.2.110 code-server LXC).
#   Needs: kubectl configured, git installed.
# ─────────────────────────────────────────────────────────────────────────────

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/**'
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  IMAGE_NAME: crewai-studio
  INFRA_REPO: salih18/homelab-cluster
  K8S_NAMESPACE: crewai

concurrency:
  group: ghcr-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Build (GitHub-hosted runner) ───────────────────────────────────────────

  build:
    name: Build & push crewai-studio
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name == 'push' }}
          pull: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # ── Deploy (self-hosted runner with LAN access to cluster) ─────────────────

  deploy:
    name: Deploy CrewAI-Studio → crewai
    needs: build
    if: github.event_name == 'push'
    runs-on: self-hosted
    steps:
      - name: Roll out new image
        run: |
          kubectl set image deployment/crewai-studio \
            crewai-studio=${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n ${{ env.K8S_NAMESPACE }}
          kubectl rollout status deployment/crewai-studio \
            -n ${{ env.K8S_NAMESPACE }} --timeout=600s

      - name: Sync image tag back to homelab.yaml
        env:
          INFRA_DEPLOY_PAT: ${{ secrets.INFRA_DEPLOY_PAT }}
        run: |
          TMP=$(mktemp -d)
          git clone \
            https://x-access-token:${INFRA_DEPLOY_PAT}@github.com/${{ env.INFRA_REPO }}.git \
            "$TMP"
          sed -i \
            's|ghcr\.io/salih18/crewai-studio:[^"]*|ghcr.io/salih18/crewai-studio:${{ github.sha }}|' \
            "$TMP/vars/homelab.yaml"
          cd "$TMP"
          git config user.email "github-actions@ci.local"
          git config user.name "GitHub Actions"
          git add vars/homelab.yaml
          git diff --cached --quiet \
            || git commit -m "ci: crewai-studio → ${{ github.sha }}"
          git push
